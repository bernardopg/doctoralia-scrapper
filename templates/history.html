{% extends "base.html" %}

{% block title %}Histórico - Doctoralia Scraper{% endblock %}

{% block page_title %}Histórico de Scraping{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-list-alt"></i>
      Tarefas Recentes
    </h3>
    <div class="card-actions">
      <button class="btn btn-secondary btn-sm" onclick="loadTasks()">
        <i class="fas fa-sync-alt"></i>
        Atualizar
      </button>
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID da Tarefa</th>
            <th>Status</th>
            <th>Progresso</th>
            <th>Mensagem</th>
            <th>Criado em</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tasks-table-body">
          <tr>
            <td colspan="6" class="text-center text-secondary">Carregando tarefas...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table th,
  .table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #3a3a3c);
  }

  .table th {
    font-weight: 600;
    color: var(--text-secondary, #8e8e93);
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .table td {
    color: var(--text-primary, #fff);
    font-size: 14px;
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-pending {
    background: rgba(255, 149, 0, 0.15);
    color: #ff9500;
  }

  .status-running {
    background: rgba(10, 132, 255, 0.15);
    color: #0a84ff;
  }

  .status-completed {
    background: rgba(52, 199, 89, 0.15);
    color: #34c759;
  }

  .status-failed {
    background: rgba(255, 59, 48, 0.15);
    color: #ff3b30;
  }

  .progress-bar-container {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: var(--primary-color, #0a84ff);
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .progress-bar-animated {
    background: linear-gradient(
      90deg,
      var(--primary-color, #0a84ff) 0%,
      #5ac8fa 50%,
      var(--primary-color, #0a84ff) 100%
    );
    background-size: 200% 100%;
    animation: progress-shine 1.5s ease infinite;
  }

  @keyframes progress-shine {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  let pollInterval = null;

  async function loadTasks() {
    const tbody = document.getElementById('tasks-table-body');

    try {
      const response = await fetch('/api/tasks');

      let tasks = [];
      if (response.ok) {
        tasks = await response.json();
      } else {
        console.warn('Failed to fetch tasks');
        tasks = [];
      }

      if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary">Nenhuma tarefa encontrada</td></tr>';
        stopPolling();
        return;
      }

      const hasActiveTasks = tasks.some(t => t.status === 'running' || t.status === 'pending');

      tbody.innerHTML = tasks.map(task => {
        const progressPct = Math.round(task.progress);
        const isActive = task.status === 'running' || task.status === 'pending';
        const statusLabel = {
          'pending': 'Pendente',
          'running': 'Em andamento',
          'completed': 'Concluído',
          'failed': 'Falhou'
        }[task.status] || task.status;

        return `
        <tr>
          <td><span style="font-family: monospace; font-size: 12px;">${task.task_id}</span></td>
          <td><span class="status-badge status-${task.status}">${statusLabel}</span></td>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="progress-bar-container" style="width: 120px; height: 8px;">
                <div class="progress-bar${isActive ? ' progress-bar-animated' : ''}" style="width: ${progressPct}%"></div>
              </div>
              <span style="font-size: 12px; min-width: 35px;">${progressPct}%</span>
            </div>
          </td>
          <td style="font-size: 13px;">${task.message || '-'}</td>
          <td style="font-size: 13px;">${new Date(task.created_at).toLocaleString('pt-BR')}</td>
          <td>
            <button class="icon-btn" title="Ver Detalhes" onclick="viewTask('${task.task_id}')">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        </tr>`;
      }).join('');

      // Auto-poll while there are active tasks
      if (hasActiveTasks) {
        startPolling();
      } else {
        stopPolling();
      }

    } catch (error) {
      console.error('Error loading tasks:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-error">Erro ao carregar tarefas</td></tr>';
    }
  }

  function startPolling() {
    if (!pollInterval) {
      pollInterval = setInterval(loadTasks, 2000);
    }
  }

  function stopPolling() {
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }
  }

  function viewTask(taskId) {
    alert('Detalhes da tarefa: ' + taskId);
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadTasks();
    // Start polling initially, will auto-stop if no active tasks
    startPolling();
  });
</script>
{% endblock %}