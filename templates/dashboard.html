{% extends "base.html" %}

{% block title %}Dashboard - Doctoralia Scraper{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-label">Total de Scrapes</span>
      <div class="stat-icon blue">
        <i class="fas fa-database"></i>
      </div>
    </div>
    <div class="stat-value" id="stat-total">-</div>
    <div class="stat-trend" id="stat-total-trend">
      <i class="fas fa-minus"></i>
      <span id="stat-total-trend-text">Carregando...</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-label">Total Reviews</span>
      <div class="stat-icon green">
        <i class="fas fa-check-circle"></i>
      </div>
    </div>
    <div class="stat-value" id="stat-success">-</div>
    <div class="stat-trend" id="stat-success-trend">
      <i class="fas fa-minus"></i>
      <span id="stat-success-trend-text">-</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-label">Erros</span>
      <div class="stat-icon red">
        <i class="fas fa-times-circle"></i>
      </div>
    </div>
    <div class="stat-value" id="stat-failures">-</div>
    <div class="stat-trend" id="stat-failures-trend">
      <i class="fas fa-minus"></i>
      <span id="stat-failures-trend-text">-</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-label">Rating Médio</span>
      <div class="stat-icon orange">
        <i class="fas fa-clock"></i>
      </div>
    </div>
    <div class="stat-value" id="stat-avg-time">-</div>
    <div class="stat-trend" id="stat-avg-time-trend">
      <i class="fas fa-minus"></i>
      <span id="stat-avg-time-trend-text">-</span>
    </div>
  </div>
</div>

<!-- Cards Section -->
<div class="dashboard-grid"
  style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 32px;">
  <!-- Performance Chart Card -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-chart-pie"></i>
        Performance Overview
      </h3>
    </div>
    <div class="card-body">
      <div style="height: 300px; position: relative;">
        <canvas id="performanceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Recent Activity Card -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-history"></i>
        Atividades Recentes
      </h3>
    </div>
    <div class="card-body">
      <div id="activities-content" style="max-height: 300px; overflow-y: auto;">
        <div class="text-center" style="padding: 40px 20px; color: var(--text-secondary);">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
          <p style="margin-top: 16px;">Carregando atividades...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quality Analysis Card -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-microscope"></i>
      Análise de Qualidade de Resposta
    </h3>
  </div>
  <div class="card-body">
    <div class="form-group">
      <label class="form-label">Cole a resposta do médico para análise:</label>
      <textarea id="response-text" class="form-control" rows="6"
        placeholder="Cole o texto da resposta aqui..."></textarea>
    </div>
    <button class="btn btn-primary" onclick="analyzeQuality()">
      <i class="fas fa-search"></i>
      Analisar Qualidade
    </button>
    <div id="quality-result" style="display: none; margin-top: 20px;"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Load stats
  async function loadStats() {
    try {
      const response = await fetch('/api/stats');
      const result = await response.json();
      const data = result.data || result;

      // Total de scrapes (médicos raspados)
      const totalScraped = data.total_scraped_doctors || data.total_scrapes || 0;
      document.getElementById('stat-total').textContent = totalScraped;

      // Sucessos - usar total de reviews como indicador de sucesso
      const totalReviews = data.total_reviews || 0;
      document.getElementById('stat-success').textContent = totalReviews;

      // Falhas - atualmente não rastreamos, mostrar 0
      const failures = data.failed_scrapes || 0;
      document.getElementById('stat-failures').textContent = failures;

      // Tempo médio (se disponível) ou mostrar rating médio
      const avgTime = data.average_time || null;
      const avgRating = data.average_rating || 0;
      if (avgTime) {
        document.getElementById('stat-avg-time').textContent = avgTime.toFixed(1) + 's';
      } else if (avgRating > 0) {
        document.getElementById('stat-avg-time').textContent = avgRating.toFixed(1) + '★';
        // Atualizar label se necessário
        const avgTimeLabel = document.querySelector('#stat-avg-time').parentElement.querySelector('.stat-label');
        if (avgTimeLabel) avgTimeLabel.textContent = 'Avaliação Média';
      } else {
        document.getElementById('stat-avg-time').textContent = '-';
      }

      // Atualizar textos de tendência dinamicamente
      updateTrendTexts(data, totalScraped, totalReviews, failures);

    } catch (error) {
      console.error('Error loading stats:', error);
      // Mostrar estado de erro
      document.getElementById('stat-total-trend-text').textContent = 'Erro ao carregar';
    }
  }

  // Atualizar textos de tendência
  function updateTrendTexts(data, totalScraped, totalReviews, failures) {
    // Total - mostrar última raspagem
    const totalTrend = document.getElementById('stat-total-trend');
    const totalTrendText = document.getElementById('stat-total-trend-text');
    if (data.last_scrape_time) {
      const lastScrape = new Date(data.last_scrape_time);
      const now = new Date();
      const diffHours = Math.round((now - lastScrape) / (1000 * 60 * 60));
      if (diffHours < 1) {
        totalTrendText.textContent = 'Última raspagem: agora';
      } else if (diffHours < 24) {
        totalTrendText.textContent = `Última: há ${diffHours}h`;
      } else {
        const diffDays = Math.round(diffHours / 24);
        totalTrendText.textContent = `Última: há ${diffDays}d`;
      }
      totalTrend.classList.add('up');
      totalTrend.querySelector('i').className = 'fas fa-clock';
    } else if (totalScraped > 0) {
      totalTrendText.textContent = `${totalScraped} médico(s)`;
    } else {
      totalTrendText.textContent = 'Nenhum dado';
    }

    // Sucesso - mostrar média de reviews por médico
    const successTrend = document.getElementById('stat-success-trend');
    const successTrendText = document.getElementById('stat-success-trend-text');
    if (totalScraped > 0 && totalReviews > 0) {
      const avgReviews = (totalReviews / totalScraped).toFixed(1);
      successTrendText.textContent = `~${avgReviews} reviews/médico`;
      successTrend.classList.add('up');
      successTrend.querySelector('i').className = 'fas fa-arrow-up';
    } else {
      successTrendText.textContent = 'Nenhuma review';
    }

    // Falhas - mostrar taxa
    const failuresTrend = document.getElementById('stat-failures-trend');
    const failuresTrendText = document.getElementById('stat-failures-trend-text');
    if (totalScraped > 0) {
      const failureRate = ((failures / (totalScraped + failures)) * 100).toFixed(1);
      failuresTrendText.textContent = `${failureRate}% taxa de falha`;
      if (failures === 0) {
        failuresTrend.querySelector('i').className = 'fas fa-check';
      } else {
        failuresTrend.classList.add('down');
        failuresTrend.querySelector('i').className = 'fas fa-arrow-down';
      }
    } else {
      failuresTrendText.textContent = '-';
    }

    // Tempo/Rating - mostrar info de plataformas
    const avgTimeTrend = document.getElementById('stat-avg-time-trend');
    const avgTimeTrendText = document.getElementById('stat-avg-time-trend-text');
    if (data.platform_stats && Object.keys(data.platform_stats).length > 0) {
      const platforms = Object.keys(data.platform_stats);
      avgTimeTrendText.textContent = `${platforms.length} plataforma(s)`;
      avgTimeTrend.querySelector('i').className = 'fas fa-globe';
    } else {
      avgTimeTrendText.textContent = '-';
    }
  }

  // Load performance data
  async function loadPerformance() {
    try {
      const response = await fetch('/api/performance');
      const result = await response.json();
      const data = result.data || result;

      // Se não há dados de performance, tentar usar stats
      if (data.message && !data.total_operations) {
        // Buscar stats como fallback
        const statsResponse = await fetch('/api/stats');
        const statsResult = await statsResponse.json();
        const statsData = statsResult.data || statsResult;

        if (statsData && statsData.platform_stats) {
          updatePerformanceChartWithStats(statsData);
        }
        return;
      }

      updatePerformanceChart(data);
    } catch (error) {
      console.error('Error loading performance:', error);
    }
  }

  // Update performance chart com dados de stats (fallback)
  function updatePerformanceChartWithStats(data) {
    const chartElement = document.getElementById('performanceChart');
    if (!chartElement) {
      console.warn('Performance chart element not found');
      return;
    }

    const ctx = chartElement.getContext('2d');

    if (performanceChart) {
      performanceChart.destroy();
    }

    // Usar dados de plataformas ou médicos/reviews
    const platforms = data.platform_stats || {};
    const platformNames = Object.keys(platforms);

    if (platformNames.length === 0) {
      // Sem dados - mostrar médicos vs reviews
      const doctors = data.total_scraped_doctors || 0;
      const reviews = data.total_reviews || 0;

      if (doctors === 0 && reviews === 0) {
        // Sem nenhum dado
        chartElement.parentElement.innerHTML = `
            <div class="text-center" style="padding: 40px 20px; color: var(--text-secondary);">
              <i class="fas fa-chart-pie" style="font-size: 48px; opacity: 0.2;"></i>
              <p style="margin-top: 16px;">Sem dados para exibir</p>
              <p style="font-size: 12px;">Execute um scraping para visualizar métricas</p>
            </div>
          `;
        return;
      }

      performanceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Médicos', 'Reviews'],
          datasets: [{
            data: [doctors, reviews],
            backgroundColor: ['#0A84FF', '#34C759'],
            borderWidth: 0
          }]
        },
        options: getChartOptions()
      });
      return;
    }

    // Mostrar dados por plataforma
    const colors = ['#0A84FF', '#34C759', '#FF9500', '#FF3B30', '#AF52DE'];
    performanceChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: platformNames.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
        datasets: [{
          data: platformNames.map(p => platforms[p].reviews || 0),
          backgroundColor: colors.slice(0, platformNames.length),
          borderWidth: 0
        }]
      },
      options: getChartOptions()
    });
  }

  // Update performance chart com dados de operações
  function updatePerformanceChart(data) {
    const chartElement = document.getElementById('performanceChart');
    if (!chartElement) {
      console.warn('Performance chart element not found');
      return;
    }

    const ctx = chartElement.getContext('2d');

    if (performanceChart) {
      performanceChart.destroy();
    }

    const successful = data.successful_operations || 0;
    const total = data.total_operations || 0;
    const failed = total - successful;

    if (total === 0) {
      // Sem operações - mostrar placeholder
      chartElement.parentElement.innerHTML = `
          <div class="text-center" style="padding: 40px 20px; color: var(--text-secondary);">
            <i class="fas fa-chart-pie" style="font-size: 48px; opacity: 0.2;"></i>
            <p style="margin-top: 16px;">Aguardando operações</p>
          </div>
        `;
      return;
    }

    performanceChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Sucesso', 'Falha'],
        datasets: [{
          data: [successful, failed],
          backgroundColor: ['#34C759', '#FF3B30'],
          borderWidth: 0
        }]
      },
      options: getChartOptions()
    });
  }

  // Opções comuns do gráfico
  function getChartOptions() {
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: {
              family: '-apple-system, BlinkMacSystemFont, SF Pro Display',
              size: 13
            }
          }
        }
      },
      cutout: '70%'
    };
  }

  // Load recent activity
  async function loadRecentActivity() {
    try {
      const response = await fetch('/api/recent-activity');
      const activities = await response.json();
      const container = document.getElementById('activities-content');

      if (activities.length === 0) {
        container.innerHTML = `
            <div class="text-center" style="padding: 40px 20px; color: var(--text-secondary);">
              <i class="fas fa-history" style="font-size: 48px; opacity: 0.2;"></i>
              <p style="margin-top: 16px;">Nenhuma atividade recente</p>
            </div>
          `;
        return;
      }

      container.innerHTML = activities.map(activity => `
          <div class="activity-item" style="padding: 12px 0; border-bottom: 1px solid var(--border-color, #3a3a3c);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 500;">${activity.doctor_name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  ${activity.reviews_count} reviews • ${activity.platform}
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600; color: var(--apple-green, #34c759);">
                  ${activity.average_rating.toFixed(1)} ★
                </div>
                <div style="font-size: 11px; color: var(--text-secondary);">
                  ${new Date(activity.scraped_at).toLocaleDateString()}
                </div>
              </div>
            </div>
          </div>
        `).join('');

    } catch (error) {
      console.error('Error loading activities:', error);
      document.getElementById('activities-content').innerHTML = `
          <div class="text-center" style="padding: 20px; color: var(--apple-red, #ff3b30);">
            Erro ao carregar atividades
          </div>
        `;
    }
  }

  // Analyze quality
  async function analyzeQuality() {
    const text = document.getElementById('response-text').value;
    if (!text) {
      alert('Por favor, insira o texto da resposta.');
      return;
    }

    const resultDiv = document.getElementById('quality-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Analisando...</div>';

    try {
      const response = await fetch('/api/quality-analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ response: text })
      });

      const result = await response.json();

      if (result.error) {
        resultDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
        return;
      }

      // Render results
      const scoreColor = result.score.total_score >= 80 ? '#34C759' : (result.score.total_score >= 60 ? '#FF9500' : '#FF3B30');

      resultDiv.innerHTML = `
          <div style="background: var(--bg-tertiary, #3a3a3c); border-radius: 12px; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;">Resultado da Análise</h4>
              <div style="background: ${scoreColor}; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                Score: ${result.score.total_score}/100
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <h5 style="color: var(--apple-green, #34c759); margin-bottom: 8px;">Pontos Fortes</h5>
                <ul style="padding-left: 20px; font-size: 13px;">
                  ${result.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
              </div>
              <div>
                <h5 style="color: var(--apple-red, #ff3b30); margin-bottom: 8px;">Pontos de Melhoria</h5>
                <ul style="padding-left: 20px; font-size: 13px;">
                  ${result.weaknesses.map(w => `<li>${w}</li>`).join('')}
                </ul>
              </div>
            </div>

            <div>
              <h5 style="color: var(--apple-blue, #0a84ff); margin-bottom: 8px;">Sugestões</h5>
              <ul style="padding-left: 20px; font-size: 13px;">
                ${result.suggestions.map(s => `<li>${s}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;

    } catch (error) {
      console.error('Error analyzing quality:', error);
      resultDiv.innerHTML = `<div class="alert alert-error">Erro ao analisar qualidade: ${error.message}</div>`;
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function () {
    loadStats();
    loadPerformance();
    loadRecentActivity();
  });
</script>
{% endblock %}